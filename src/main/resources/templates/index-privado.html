<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>ProMaq Solutions - Catálogo de Productos</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

    <style>
        body {
            background-color: #f0f2f5;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .container {
            flex: 1;
            max-width: 960px;
            margin-top: 40px;
            margin-bottom: 40px;
        }

        h1 {
            font-weight: 700;
            color: #0d6efd;
            text-align: center;
            margin-bottom: 0.5rem;
        }

        .lead {
            text-align: center;
            color: #555;
            margin-bottom: 2rem;
        }

        .card {
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
            background-color: #ffffff;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.12);
        }

        .card-img-top {
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
            height: 200px;
            object-fit: cover;
        }

        .card-title {
            font-weight: 600;
            color: #333;
        }

        .card-text {
            color: #666;
        }

        .card-text strong {
            color: #0d6efd;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4a90e2, #357ABD);
            border: none;
            color: white;
            font-weight: 700;
            padding: 12px 30px;
            border-radius: 12px;
            box-shadow: 0 6px 12px rgba(69, 114, 186, 0.4);
            transition: background 0.3s ease, box-shadow 0.3s ease, transform 0.2s ease;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #357ABD, #2a5eaa);
            box-shadow: 0 8px 20px rgba(53, 122, 189, 0.6);
            transform: translateY(-2px);
            text-decoration: none;
        }

        .btn-primary:active {
            transform: translateY(1px);
            box-shadow: 0 4px 8px rgba(53, 122, 189, 0.5);
        }

        .navbar {
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        footer.bg-light {
            box-shadow: inset 0 1px 3px rgb(0 0 0 / 0.1);
            font-size: 0.9rem;
            color: #666;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f9a825, #f57f17);
            border: none;
            color: white;
            font-weight: 700;
            padding: 14px 22px;
            border-radius: 50px;
            box-shadow: 0 6px 20px rgba(245, 127, 23, 0.6);
            transition: background 0.3s, box-shadow 0.3s;
        }

        .btn-warning:hover {
            background: linear-gradient(135deg, #f57f17, #c17900);
            box-shadow: 0 10px 28px rgba(193, 121, 0, 0.8);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745, #218838);
            border: none;
            color: white;
            font-weight: 600;
            padding: 12px 20px;
            border-radius: 12px;
            box-shadow: 0 6px 12px rgba(33, 136, 56, 0.4);
            transition: background 0.3s, box-shadow 0.3s, transform 0.2s;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #218838, #1c7430);
            box-shadow: 0 8px 20px rgba(33, 136, 56, 0.6);
            transform: translateY(-2px);
        }

        .btn-success:active {
            transform: translateY(1px);
            box-shadow: 0 4px 8px rgba(33, 136, 56, 0.5);
        }

        .btn-danger {
            border-radius: 50%;
            padding: 0 8px;
            font-size: 1.2rem;
            line-height: 1;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s;
        }

        .btn-danger:hover {
            background-color: #b02a37;
        }

        .list-group-item {
            border-radius: 8px;
            margin-bottom: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        }

        .modal-header {
            background-color: #0d6efd;
            color: white;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }

        .modal-footer {
            border-top: none;
        }
    </style>
</head>

<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
        <a class="navbar-brand" href="/">ProMaq Solutions</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
                <li class="nav-item"><a class="nav-link active" href="/">Inicio</a></li>
                <li class="nav-item"><a class="nav-link" href="/cliente/historial">Historial de Compras</a></li>
                <li class="nav-item"><a class="nav-link" href="/perfil">Mi Perfil</a></li>
            </ul>
            <div class="d-flex">
                <p class="text-white m-0 me-3">Hola, <span th:text="${usuario.nombre}">Usuario</span>!</p>
                <a href="/logout" class="btn btn-light">Cerrar sesión</a>
            </div>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <h1>Catálogo de Productos</h1>
    <p class="lead">Bienvenido a ProMaq Solutions, <span th:text="${usuario.nombre}">cliente</span>. Aquí puedes explorar nuestros productos.</p>

    <div class="row mt-4">
        <div th:if="${not #lists.isEmpty(productos)}" class="row row-cols-1 row-cols-md-3 g-4">
            <div th:each="producto, iterStat : ${productos}" class="col">
                <div class="card h-100">
                    <img th:src="${producto.foto}" class="card-img-top" alt="Imagen del producto">
                    <div class="card-body">
                        <h5 class="card-title" th:text="${producto.nombre}">Nombre del producto</h5>
                        <p class="card-text" th:text="${producto.descripcion}">Descripción del producto</p>
                        <p><strong>Precio: </strong><span class="precio" th:text="${producto.precioUnitario}">0</span></p>

                        <div th:if="${producto.stock > 0}">
                            <button class="btn btn-primary w-100"
                                    th:attr="onclick=|abrirModalCantidad(${producto.idMaquinaria}, '${producto.nombre}', ${producto.precioUnitario}, ${producto.stock})|">
                                Agregar al carrito
                            </button>
                        </div>
                        <div th:unless="${producto.stock > 0}">
                            <button class="btn btn-secondary w-100" disabled>Sin stock</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div th:if="${#lists.isEmpty(productos)}" class="alert alert-info">No hay productos disponibles en este momento.</div>
</div>

<!-- Modal para seleccionar cantidad -->
<div class="modal fade" id="modalCantidad" tabindex="-1" aria-labelledby="modalCantidadLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Seleccionar Cantidad</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="nombreProducto"></p>
                <input type="number" id="inputCantidad" class="form-control" min="1" value="1">
                <input type="hidden" id="productoId">
                <input type="hidden" id="productoPrecio">
                <input type="hidden" id="productoNombre">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="confirmarAgregar">Agregar al carrito</button>
            </div>
        </div>
    </div>
</div>

<!-- Botón flotante para mostrar carrito -->
<div style="position: fixed; bottom: 20px; right: 20px; z-index: 1050;">
    <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#carritoModal">
        Carrito (<span id="contador-carrito">0</span>)
    </button>
</div>

<!-- Modal del carrito -->
<div class="modal fade" id="carritoModal" tabindex="-1" aria-labelledby="carritoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="carritoModalLabel">Carrito de Compras</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body" id="contenido-carrito"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<footer class="bg-light mt-5 py-3">
    <div class="container text-center">
        <p>© 2025 Sistema de ProMaq Solutions. Todos los derechos reservados.</p>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const formatter = new Intl.NumberFormat('es-CO', {
            style: 'currency',
            currency: 'COP',
            minimumFractionDigits: 0
        });
        document.querySelectorAll('.precio').forEach(span => {
            const valor = Number(span.textContent.trim());
            if (!isNaN(valor)) span.textContent = formatter.format(valor);
        });
    });

    const formatter = new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 });

    function abrirModalCantidad(id, nombre, precio, stock) {
        document.getElementById("productoId").value = id;
        document.getElementById("productoNombre").value = nombre;
        document.getElementById("productoPrecio").value = precio;
        document.getElementById("inputCantidad").value = 1;
        document.getElementById("inputCantidad").max = stock;
        document.getElementById("inputCantidad").setAttribute("data-stock", stock);
        document.getElementById("nombreProducto").textContent =
            `Indique la cantidad de ${nombre} que desee agregar (Stock disponible: ${stock})`;
        new bootstrap.Modal(document.getElementById("modalCantidad")).show();
    }

    document.getElementById("confirmarAgregar").addEventListener("click", function () {
        const id = parseInt(document.getElementById("productoId").value);
        const nombre = document.getElementById("productoNombre").value;
        const precio = parseFloat(document.getElementById("productoPrecio").value);
        const cantidad = parseInt(document.getElementById("inputCantidad").value);
        const stock = parseInt(document.getElementById("inputCantidad").getAttribute("data-stock"));
        if (isNaN(cantidad) || cantidad < 1) { alert("Cantidad inválida."); return; }
        if (cantidad > stock) { alert(`No hay suficientes ${nombre} en el almacén. Solo quedan ${stock} unidades.`); return; }

        let carrito = JSON.parse(localStorage.getItem('carrito')) || [];
        const index = carrito.findIndex(p => p.id === id);
        const cantidadEnCarrito = index !== -1 ? carrito[index].cantidad : 0;
        if (cantidad + cantidadEnCarrito > stock) { alert(`Ya tienes ${cantidadEnCarrito} en el carrito. Solo puedes agregar ${stock - cantidadEnCarrito} más.`); return; }
        if (index !== -1) carrito[index].cantidad += cantidad; else carrito.push({ id, nombre, precio, cantidad });
        localStorage.setItem('carrito', JSON.stringify(carrito));
        actualizarContador();
        bootstrap.Modal.getInstance(document.getElementById("modalCantidad")).hide();
        alert(`${nombre} x${cantidad} agregado(s) al carrito.`);
    });

    function actualizarContador() {
        let carrito = JSON.parse(localStorage.getItem('carrito')) || [];
        document.getElementById('contador-carrito').textContent = carrito.reduce((acc, p) => acc + p.cantidad, 0);
    }

    function mostrarContenidoCarrito() {
        let carrito = JSON.parse(localStorage.getItem('carrito')) || [];
        let contenido = '';
        if (carrito.length === 0) contenido = '<p>El carrito está vacío.</p>';
        else {
            contenido += '<ul class="list-group">';
            carrito.forEach((p, index) => {
                const totalPorProducto = p.precio * p.cantidad;
                contenido += `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="my-0">${p.nombre}</h6>
                            <small class="text-muted">Cantidad: ${p.cantidad}</small>
                        </div>
                        <span class="text-muted mx-3">${formatter.format(totalPorProducto)}</span>
                        <button class="btn btn-sm btn-danger eliminar-btn" data-index="${index}">&times;</button>
                    </li>`;
            });
            contenido += '</ul>';
            const total = carrito.reduce((acc, p) => acc + (p.precio * p.cantidad), 0);
            contenido += `<div class="mt-3 text-end"><strong>Total: ${formatter.format(total)}</strong></div>`;
            contenido += `<div class="d-grid mt-3"><button id="btnPagar" class="btn btn-success">Ir a pagar</button></div>`;
        }
        document.getElementById('contenido-carrito').innerHTML = contenido;
        document.querySelectorAll('.eliminar-btn').forEach(btn => btn.addEventListener('click', () => {
            carrito.splice(parseInt(btn.getAttribute('data-index')), 1);
            localStorage.setItem('carrito', JSON.stringify(carrito));
            mostrarContenidoCarrito();
            actualizarContador();
        }));
        const btnPagar = document.getElementById('btnPagar');
        if (btnPagar) btnPagar.addEventListener('click', () => {
            if (carrito.length === 0) { alert("El carrito está vacío."); return; }
            window.location.href = "/pago";
        });
    }

    actualizarContador();
    document.getElementById('carritoModal').addEventListener('show.bs.modal', mostrarContenidoCarrito);
</script>
</body>
</html>
